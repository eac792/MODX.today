id: 104
pagetitle: 'Getting Share Counts with a Snippet'
alias: getting-share-counts-with-a-snippet
parent: 1
introtext: '<p>At the bottom of MODX.today articles is a simple counter that shows how many times a post has been shared.&nbsp;This includes data from&nbsp;Facebook, Twitter and Google+. The code is pretty simple, so if you want to do the same, just keep reading... and don''t forget to share ;)</p>'
template: 2
menuindex: 18
createdby: 2
uri: posts/getting-share-counts-with-a-snippet
show_in_tree: 0
properties: '{"contentblocks":{"content":"[{\"layout\":3,\"content\":{\"col1\":[{\"value\":\"<p>\\n\\tAt the bottom of MODX.today articles is a simple counter that shows how many times a post has been shared. This includes data from Facebook, Twitter and Google+. The code is pretty simple, so if you want to do the same, we''ve got you covered!<\/p>\",\"field\":2,\"settings\":[]},{\"value\":\"Step 1: The Snippet\",\"level\":\"h2\",\"field\":3,\"settings\":[]},{\"value\":\"<p>We''ve done the hard work for you, and wrote a snippet that asks Facebook, Twitter and Google Plus for their total share&nbsp;counts. Copy\/paste the code below into a new snippet and give it the name <strong>getShareCount<\/strong>.<\/p><p>The snippet already includes caching (15 minutes) and it will return the share data as a simple JSON-encoded array. Aside from the grand total number of shares, it also contains the count split up for&nbsp;each of the data sources.&nbsp;<\/p>\",\"field\":2,\"settings\":[]},{\"value\":\"<?php\\n$resourceId = $modx->getOption(''resource'', $_REQUEST, $modx->resource->get(''id''));\\n$url = $modx->makeUrl($resourceId, '''', '''', ''full'');\\n$urlHash = md5($url);\\n\\n$cached = $modx->cacheManager->get(''shares\/'' . $urlHash);\\nif (is_array($cached)) {\\n    return $modx->toJSON($cached);\\n}\\n\\n$urlEnc = urlencode($url);\\n$total = 0;\\n$results = array(\\n    ''url'' => $url,\\n    ''sources'' => array(),\\n);\\n\\n\/\/ Facebook\\n$fbUrl = \\\"http:\/\/api.facebook.com\/restserver.php?method=links.getStats&format=json&urls={$urlEnc}\\\";\\n$fbCount = reset($modx->fromJSON(file_get_contents($fbUrl)));\\n\/\/ var_dump($fbCount);\\nif (is_array($fbCount) && isset($fbCount[''total_count''])) {\\n    $total += $fbCount[''total_count''];\\n    $results[''sources''][''facebook''] = $fbCount[''total_count''];\\n}\\n\\n\/\/ Twitter - private endpoint\\n$twitterUrl = \\\"https:\/\/cdn.api.twitter.com\/1\/urls\/count.json?url={$urlEnc}\\\";\\n$twitterCount = $modx->fromJSON(file_get_contents($twitterUrl));\\n\/\/ var_dump($twitterCount);\\n\\nif (is_array($twitterCount) && isset($twitterCount[''count''])) {\\n    $total += $twitterCount[''count''];\\n    $results[''sources''][''twitter''] = $twitterCount[''count''];\\n}\\n\\n\/\/ Google+ - private endpoint\\n$curl = curl_init();\\ncurl_setopt($curl, CURLOPT_URL, \\\"https:\/\/clients6.google.com\/rpc\\\");\\ncurl_setopt($curl, CURLOPT_POST, 1);\\ncurl_setopt($curl, CURLOPT_POSTFIELDS, ''[{\\\"method\\\":\\\"pos.plusones.get\\\",\\\"id\\\":\\\"p\\\",\\\"params\\\":{\\\"nolog\\\":true,\\\"id\\\":\\\"'' . $url . ''\\\",\\\"source\\\":\\\"widget\\\",\\\"userId\\\":\\\"@viewer\\\",\\\"groupId\\\":\\\"@self\\\"},\\\"jsonrpc\\\":\\\"2.0\\\",\\\"key\\\":\\\"p\\\",\\\"apiVersion\\\":\\\"v1\\\"}]'');\\ncurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\\ncurl_setopt($curl, CURLOPT_HTTPHEADER, array(''Content-type: application\/json''));\\n$curl_results = curl_exec ($curl);\\ncurl_close ($curl);\\n$json = json_decode($curl_results, true);\\n\\nif (isset($json[0][''result''][''metadata''][''globalCounts''][''count''])) {\\n    $total += $json[0][''result''][''metadata''][''globalCounts''][''count''];\\n    $results[''sources''][''googleplus''] = $json[0][''result''][''metadata''][''globalCounts''][''count''];\\n}\\n\\n$results[''total''] = $total;\\n\\n$modx->cacheManager->set(''shares\/'' . $urlHash, $results, 60 * 15);\\nreturn $modx->toJSON($results);\",\"lang\":\"php\",\"field\":10,\"settings\":{}},{\"value\":\"Step 2: The Resource\",\"level\":\"h2\",\"field\":3,\"settings\":[]},{\"value\":\"<p>To make sure the rendering of the page is not delayed if one of the services is slow to respond, we wont be including the snippet into the article pages where you want the counts to be displayed. Instead, we''ll use a touch of AJAX to load it asynchronously.&nbsp;<\/p><p>For this, we''ll need a resource that contains the snippet, which will return the JSON-encoded array from the&nbsp;snippet.&nbsp;<\/p><p>Create a new resource with the following values:<\/p><ul>\\n<li>Pagetitle: whatever you want, probably something along the lines of \\\"Shares\\\"<\/li><li>Alias: whatever you want, but for this article we''ll assume you used \\\"shares\\\"<\/li><li>Template: empty<\/li><li>Published and Hidden from Menu<\/li><li>Content Type: JSON<\/li><li>Rich Text and&nbsp;Searchable off&nbsp;<\/li><li>If using ContentBlocks, make sure to disable that on the resource too as that can inject markup from your layouts.<\/li><\/ul><p>In the content of the resource, just call the getShareCount snippet uncached.&nbsp;<\/p>\",\"field\":2,\"settings\":[]},{\"value\":\"[[!getShareCount]]\",\"lang\":\"html\",\"field\":10,\"settings\":{}},{\"value\":\"Step 3: The JavaScript\",\"level\":\"h2\",\"field\":3,\"settings\":[]},{\"value\":\"<p>Somewhere in your Article template, use the following piece of JavaScript to load the share counts after the page is ready. Place it at the bottom of the page, right before the closing &lt;\/body&gt; tag. Please note that this code makes use of jQuery - make sure it is loaded, or rewrite it if you''re not using that.&nbsp;<\/p>\",\"field\":2,\"settings\":[]},{\"value\":\"$(document).on(''ready'', function() {\\n    $.ajax({\\n        dataType: \\\"json\\\",\\n        url: ''[[~SNIPPET_RESOURCE_ID_HERE? &resource=`[[*id]]`]]'',\\n        success: function(data) {\\n            if (data.total) {\\n                $(''.total_shares'').text(data.total);\\n            }\\n            if (data.sources.facebook > 0) {\\n                $(''.total_facebook_shares'').text(data.sources.facebook);\\n            }\\n            if (data.sources.twitter > 0) {\\n                $(''.total_twitter_shares'').text(data.sources.twitter);\\n            }\\n            if (data.sources.googleplus > 0) {\\n                $(''.total_googleplus_shares'').text(data.sources.googleplus);\\n            }\\n        }\\n    });\\n});\",\"lang\":\"javascript\",\"field\":10,\"settings\":{}},{\"value\":\"<p>Make sure to replace SNIPPET_RESOURCE_ID_HERE with the ID of the resource you created earlier, the one with the snippet as content. If&nbsp;you add the code to an external javascript file, you''ll need to find a different way to get the url into the function, perhaps by setting a global variable through MODX, or simply hardcoding the url or fetching the resource ID from a data attribute.&nbsp;<\/p><p>You''ll also need to make sure that you''re inserting the numbers into the right place. In the example, we''re targeting them by a special class and just setting the inner text with the number of shares.<\/p>\",\"field\":2,\"settings\":[]}]},\"settings\":[],\"parent\":0}]","linear":[{"value":"<p>\n\tAt the bottom of MODX.today articles is a simple counter that shows how many times a post has been shared. This includes data from Facebook, Twitter and Google+. The code is pretty simple, so if you want to do the same, we''ve got you covered!<\/p>","field":2,"settings":[]},{"value":"Step 1: The Snippet","level":"h2","field":3,"settings":[]},{"value":"<p>We''ve done the hard work for you, and wrote a snippet that asks Facebook, Twitter and Google Plus for their total share&nbsp;counts. Copy\/paste the code below into a new snippet and give it the name <strong>getShareCount<\/strong>.<\/p><p>The snippet already includes caching (15 minutes) and it will return the share data as a simple JSON-encoded array. Aside from the grand total number of shares, it also contains the count split up for&nbsp;each of the data sources.&nbsp;<\/p>","field":2,"settings":[]},{"value":"<?php\n$resourceId = $modx->getOption(''resource'', $_REQUEST, $modx->resource->get(''id''));\n$url = $modx->makeUrl($resourceId, '''', '''', ''full'');\n$urlHash = md5($url);\n\n$cached = $modx->cacheManager->get(''shares\/'' . $urlHash);\nif (is_array($cached)) {\n    return $modx->toJSON($cached);\n}\n\n$urlEnc = urlencode($url);\n$total = 0;\n$results = array(\n    ''url'' => $url,\n    ''sources'' => array(),\n);\n\n\/\/ Facebook\n$fbUrl = \"http:\/\/api.facebook.com\/restserver.php?method=links.getStats&format=json&urls={$urlEnc}\";\n$fbCount = reset($modx->fromJSON(file_get_contents($fbUrl)));\n\/\/ var_dump($fbCount);\nif (is_array($fbCount) && isset($fbCount[''total_count''])) {\n    $total += $fbCount[''total_count''];\n    $results[''sources''][''facebook''] = $fbCount[''total_count''];\n}\n\n\/\/ Twitter - private endpoint\n$twitterUrl = \"https:\/\/cdn.api.twitter.com\/1\/urls\/count.json?url={$urlEnc}\";\n$twitterCount = $modx->fromJSON(file_get_contents($twitterUrl));\n\/\/ var_dump($twitterCount);\n\nif (is_array($twitterCount) && isset($twitterCount[''count''])) {\n    $total += $twitterCount[''count''];\n    $results[''sources''][''twitter''] = $twitterCount[''count''];\n}\n\n\/\/ Google+ - private endpoint\n$curl = curl_init();\ncurl_setopt($curl, CURLOPT_URL, \"https:\/\/clients6.google.com\/rpc\");\ncurl_setopt($curl, CURLOPT_POST, 1);\ncurl_setopt($curl, CURLOPT_POSTFIELDS, ''[{\"method\":\"pos.plusones.get\",\"id\":\"p\",\"params\":{\"nolog\":true,\"id\":\"'' . $url . ''\",\"source\":\"widget\",\"userId\":\"@viewer\",\"groupId\":\"@self\"},\"jsonrpc\":\"2.0\",\"key\":\"p\",\"apiVersion\":\"v1\"}]'');\ncurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\ncurl_setopt($curl, CURLOPT_HTTPHEADER, array(''Content-type: application\/json''));\n$curl_results = curl_exec ($curl);\ncurl_close ($curl);\n$json = json_decode($curl_results, true);\n\nif (isset($json[0][''result''][''metadata''][''globalCounts''][''count''])) {\n    $total += $json[0][''result''][''metadata''][''globalCounts''][''count''];\n    $results[''sources''][''googleplus''] = $json[0][''result''][''metadata''][''globalCounts''][''count''];\n}\n\n$results[''total''] = $total;\n\n$modx->cacheManager->set(''shares\/'' . $urlHash, $results, 60 * 15);\nreturn $modx->toJSON($results);","lang":"php","field":10,"settings":[]},{"value":"Step 2: The Resource","level":"h2","field":3,"settings":[]},{"value":"<p>To make sure the rendering of the page is not delayed if one of the services is slow to respond, we wont be including the snippet into the article pages where you want the counts to be displayed. Instead, we''ll use a touch of AJAX to load it asynchronously.&nbsp;<\/p><p>For this, we''ll need a resource that contains the snippet, which will return the JSON-encoded array from the&nbsp;snippet.&nbsp;<\/p><p>Create a new resource with the following values:<\/p><ul>\n<li>Pagetitle: whatever you want, probably something along the lines of \"Shares\"<\/li><li>Alias: whatever you want, but for this article we''ll assume you used \"shares\"<\/li><li>Template: empty<\/li><li>Published and Hidden from Menu<\/li><li>Content Type: JSON<\/li><li>Rich Text and&nbsp;Searchable off&nbsp;<\/li><li>If using ContentBlocks, make sure to disable that on the resource too as that can inject markup from your layouts.<\/li><\/ul><p>In the content of the resource, just call the getShareCount snippet uncached.&nbsp;<\/p>","field":2,"settings":[]},{"value":"[[!getShareCount]]","lang":"html","field":10,"settings":[]},{"value":"Step 3: The JavaScript","level":"h2","field":3,"settings":[]},{"value":"<p>Somewhere in your Article template, use the following piece of JavaScript to load the share counts after the page is ready. Place it at the bottom of the page, right before the closing &lt;\/body&gt; tag. Please note that this code makes use of jQuery - make sure it is loaded, or rewrite it if you''re not using that.&nbsp;<\/p>","field":2,"settings":[]},{"value":"$(document).on(''ready'', function() {\n    $.ajax({\n        dataType: \"json\",\n        url: ''[[~SNIPPET_RESOURCE_ID_HERE? &resource=`[[*id]]`]]'',\n        success: function(data) {\n            if (data.total) {\n                $(''.total_shares'').text(data.total);\n            }\n            if (data.sources.facebook > 0) {\n                $(''.total_facebook_shares'').text(data.sources.facebook);\n            }\n            if (data.sources.twitter > 0) {\n                $(''.total_twitter_shares'').text(data.sources.twitter);\n            }\n            if (data.sources.googleplus > 0) {\n                $(''.total_googleplus_shares'').text(data.sources.googleplus);\n            }\n        }\n    });\n});","lang":"javascript","field":10,"settings":[]},{"value":"<p>Make sure to replace SNIPPET_RESOURCE_ID_HERE with the ID of the resource you created earlier, the one with the snippet as content. If&nbsp;you add the code to an external javascript file, you''ll need to find a different way to get the url into the function, perhaps by setting a global variable through MODX, or simply hardcoding the url or fetching the resource ID from a data attribute.&nbsp;<\/p><p>You''ll also need to make sure that you''re inserting the numbers into the right place. In the example, we''re targeting them by a special class and just setting the inner text with the number of shares.<\/p>","field":2,"settings":[]}],"fieldcounts":{"2":5,"3":3,"10":3},"_isContentBlocks":true}}'
tvs:
    author: markhamstra
    preview.image: ''

-----

<div class="row   " >
    <div class="[[++default_article_column_classnames]]">
        <p>
	At the bottom of MODX.today articles is a simple counter that shows how many times a post has been shared. This includes data from Facebook, Twitter and Google+. The code is pretty simple, so if you want to do the same, we've got you covered!</p>

<h2>Step 1: The Snippet</h2>

<p>We've done the hard work for you, and wrote a snippet that asks Facebook, Twitter and Google Plus for their total share&nbsp;counts. Copy/paste the code below into a new snippet and give it the name <strong>getShareCount</strong>.</p><p>The snippet already includes caching (15 minutes) and it will return the share data as a simple JSON-encoded array. Aside from the grand total number of shares, it also contains the count split up for&nbsp;each of the data sources.&nbsp;</p>

<pre><code class="language-php">&lt;?php
$resourceId = $modx-&gt;getOption('resource', $_REQUEST, $modx-&gt;resource-&gt;get('id'));
$url = $modx-&gt;makeUrl($resourceId, '', '', 'full');
$urlHash = md5($url);

$cached = $modx-&gt;cacheManager-&gt;get('shares/' . $urlHash);
if (is_array($cached)) {
    return $modx-&gt;toJSON($cached);
}

$urlEnc = urlencode($url);
$total = 0;
$results = array(
    'url' =&gt; $url,
    'sources' =&gt; array(),
);

// Facebook
$fbUrl = &quot;http://api.facebook.com/restserver.php?method=links.getStats&amp;format=json&amp;urls={$urlEnc}&quot;;
$fbCount = reset($modx-&gt;fromJSON(file_get_contents($fbUrl)));
// var_dump($fbCount);
if (is_array($fbCount) &amp;&amp; isset($fbCount&#91;'total_count'&#93;)) {
    $total += $fbCount&#91;'total_count'&#93;;
    $results&#91;'sources'&#93;&#91;'facebook'&#93; = $fbCount&#91;'total_count'&#93;;
}

// Twitter - private endpoint
$twitterUrl = &quot;https://cdn.api.twitter.com/1/urls/count.json?url={$urlEnc}&quot;;
$twitterCount = $modx-&gt;fromJSON(file_get_contents($twitterUrl));
// var_dump($twitterCount);

if (is_array($twitterCount) &amp;&amp; isset($twitterCount&#91;'count'&#93;)) {
    $total += $twitterCount&#91;'count'&#93;;
    $results&#91;'sources'&#93;&#91;'twitter'&#93; = $twitterCount&#91;'count'&#93;;
}

// Google+ - private endpoint
$curl = curl_init();
curl_setopt($curl, CURLOPT_URL, &quot;https://clients6.google.com/rpc&quot;);
curl_setopt($curl, CURLOPT_POST, 1);
curl_setopt($curl, CURLOPT_POSTFIELDS, '&#91;{&quot;method&quot;:&quot;pos.plusones.get&quot;,&quot;id&quot;:&quot;p&quot;,&quot;params&quot;:{&quot;nolog&quot;:true,&quot;id&quot;:&quot;' . $url . '&quot;,&quot;source&quot;:&quot;widget&quot;,&quot;userId&quot;:&quot;@viewer&quot;,&quot;groupId&quot;:&quot;@self&quot;},&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;key&quot;:&quot;p&quot;,&quot;apiVersion&quot;:&quot;v1&quot;}&#93;');
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
curl_setopt($curl, CURLOPT_HTTPHEADER, array('Content-type: application/json'));
$curl_results = curl_exec ($curl);
curl_close ($curl);
$json = json_decode($curl_results, true);

if (isset($json&#91;0&#93;&#91;'result'&#93;&#91;'metadata'&#93;&#91;'globalCounts'&#93;&#91;'count'&#93;)) {
    $total += $json&#91;0&#93;&#91;'result'&#93;&#91;'metadata'&#93;&#91;'globalCounts'&#93;&#91;'count'&#93;;
    $results&#91;'sources'&#93;&#91;'googleplus'&#93; = $json&#91;0&#93;&#91;'result'&#93;&#91;'metadata'&#93;&#91;'globalCounts'&#93;&#91;'count'&#93;;
}

$results&#91;'total'&#93; = $total;

$modx-&gt;cacheManager-&gt;set('shares/' . $urlHash, $results, 60 * 15);
return $modx-&gt;toJSON($results);</code></pre>

<h2>Step 2: The Resource</h2>

<p>To make sure the rendering of the page is not delayed if one of the services is slow to respond, we wont be including the snippet into the article pages where you want the counts to be displayed. Instead, we'll use a touch of AJAX to load it asynchronously.&nbsp;</p><p>For this, we'll need a resource that contains the snippet, which will return the JSON-encoded array from the&nbsp;snippet.&nbsp;</p><p>Create a new resource with the following values:</p><ul>
<li>Pagetitle: whatever you want, probably something along the lines of "Shares"</li><li>Alias: whatever you want, but for this article we'll assume you used "shares"</li><li>Template: empty</li><li>Published and Hidden from Menu</li><li>Content Type: JSON</li><li>Rich Text and&nbsp;Searchable off&nbsp;</li><li>If using ContentBlocks, make sure to disable that on the resource too as that can inject markup from your layouts.</li></ul><p>In the content of the resource, just call the getShareCount snippet uncached.&nbsp;</p>

<pre><code class="language-markup">&#91;&#91;!getShareCount&#93;&#93;</code></pre>

<h2>Step 3: The JavaScript</h2>

<p>Somewhere in your Article template, use the following piece of JavaScript to load the share counts after the page is ready. Place it at the bottom of the page, right before the closing &lt;/body&gt; tag. Please note that this code makes use of jQuery - make sure it is loaded, or rewrite it if you're not using that.&nbsp;</p>

<pre><code class="language-javascript">$(document).on('ready', function() {
    $.ajax({
        dataType: &quot;json&quot;,
        url: '&#91;&#91;~SNIPPET_RESOURCE_ID_HERE? &amp;resource=`&#91;&#91;*id&#93;&#93;`&#93;&#93;',
        success: function(data) {
            if (data.total) {
                $('.total_shares').text(data.total);
            }
            if (data.sources.facebook &gt; 0) {
                $('.total_facebook_shares').text(data.sources.facebook);
            }
            if (data.sources.twitter &gt; 0) {
                $('.total_twitter_shares').text(data.sources.twitter);
            }
            if (data.sources.googleplus &gt; 0) {
                $('.total_googleplus_shares').text(data.sources.googleplus);
            }
        }
    });
});</code></pre>

<p>Make sure to replace SNIPPET_RESOURCE_ID_HERE with the ID of the resource you created earlier, the one with the snippet as content. If&nbsp;you add the code to an external javascript file, you'll need to find a different way to get the url into the function, perhaps by setting a global variable through MODX, or simply hardcoding the url or fetching the resource ID from a data attribute.&nbsp;</p><p>You'll also need to make sure that you're inserting the numbers into the right place. In the example, we're targeting them by a special class and just setting the inner text with the number of shares.</p>
    </div>
</div>