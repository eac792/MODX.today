!function(a,b){b.fieldTypes.repeater=function(c,d){var e=Ext.decode(d.properties.group),f=c.find(".contentblocks-repeater-wrapper"),g=tmpl("contentblocks-repeater-item"),h=d.properties&&d.properties.max_items?d.properties.max_items:0,i={init:function(){d.rows&&a.isArray(d.rows)&&d.rows.length>0?a.each(d.rows,function(a,b){i.addRow(b)}):this.addRow(),c.on("click",".contentblocks-repeater-add-item",i.addEmptyRow),c.on("click",".contentblocks-repeater-delete-row",i.deleteRow),c.on("click",".contentblocks-repeater-expanded",function(){a(this).removeClass("contentblocks-repeater-expanded").addClass("contentblocks-repeater-collapsed").text("+").closest(".contentblocks-field-repeater").children(".contentblocks-repeater-wrapper").slideUp(300,function(){b.fixColumnHeights()})}).on("click",".contentblocks-repeater-collapsed",function(){a(this).removeClass("contentblocks-repeater-collapsed").addClass("contentblocks-repeater-expanded").text("-").closest(".contentblocks-field-repeater").children(".contentblocks-repeater-wrapper").slideDown(300,function(){b.fixColumnHeights()})}),f.sortable({items:"> li",forceHelperSize:!0,forcePlaceholderSize:!0,placeholder:"ui-sortable-placeholder",tolerance:"pointer",cursor:"move",cancel:"input,textarea,button,select,option,.prevent-drag",update:function(a,c){c.item.trigger("contentblocks:field_dragged"),b.fixColumnHeights(),b.fireChange()},start:function(a,b){b.placeholder.height(b.item.height())},stop:function(b,c){if(window.tinymce){var d=c.item.find(".mceEditor");if(d.length>0){var e=a(d[0]).attr("id").replace("textarea_parent","textarea");tinymce.execCommand("mceRemoveControl",!0,e),tinymce.execCommand("mceAddControl",!0,e)}}}})},deleteRow:function(){a(this).closest(".contentblocks-repeater-row").remove()},addEmptyRow:function(){if(h>0){var a=f.children().length;if(a>=h)return void b.alert(_("contentblocks.repeater.max_items_reached",{max:h}))}i.addRow()},addRow:function(c){c=c||{};var d=a(g({}));a.each(e,function(b,e){var f=a.extend(!0,{},e);c[e.key]&&(f=a.extend(!0,{},f,c[e.key])),d.children("ul").append(i.createField(f))}),d.on("click",".contentblocks-repeater-item-expanded",function(){a(this).removeClass("contentblocks-repeater-item-expanded").addClass("contentblocks-repeater-item-collapsed").text("+").closest(".contentblocks-repeater-row").children(".contentblocks-repeater-item-wrapper").slideUp(300,function(){b.fixColumnHeights()})}).on("click",".contentblocks-repeater-item-collapsed",function(){a(this).removeClass("contentblocks-repeater-item-collapsed").addClass("contentblocks-repeater-item-expanded").text("-").closest(".contentblocks-repeater-row").children(".contentblocks-repeater-item-wrapper").slideDown(300,function(){b.fixColumnHeights()})}),f.append(d),b.fixColumnHeights()},createField:function(c){b.fldId++,c.generated_id="contentblocks-field-"+b.fldId,c.field=0;var d=_(c.name);d&&d.length&&(c.name=d);var e=a(tmpl("contentblocks-field-"+c.input,c));if(c.width>0&&e.css("width",c.width+"%"),e.data("repeater-key",c.key),"function"!=typeof b.fieldTypes[c.input])return b.alert("Uh oh, could not load the input type "+fieldType.input),!1;var f=b.fieldTypes[c.input](e,c);return f.id=c.generated_id,f.init&&setTimeout(function(){f.init()},150),b.generatedContentFields[c.generated_id]=f,e},getData:function(){var c=[];return f.children(".contentblocks-repeater-row").each(function(d,e){var f={};e=a(e),e.children("ul").children("li").each(function(c,d){d=a(d);var e=d.attr("id"),g=b.generatedContentFields[e],h=d.data("repeater-key");if(g){var i=g.getData();i.fieldId=e,f[h]=i}}),c.push(f)}),{rows:c}}};return i}}(vcJquery,ContentBlocks);