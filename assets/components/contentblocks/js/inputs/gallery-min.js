!function(a,b){b.fieldTypes.gallery=function(c,d){var e={imageCount:0,fileBrowser:!1,source:d.properties.source>0?d.properties.source:ContentBlocksConfig["image.source"],directory:d.properties.directory};return e.init=function(){this.initUpload(),c.find(".contentblocks-field-gallery-list").addClass("gallery-size-"+d.properties.thumb_size),c.find(".contentblocks-field-upload").on("click",function(){c.find(".contentblocks-field-upload-field").click()}),c.find(".contentblocks-field-gallery-choose").on("click",a.proxy(function(){this.chooseImage()},this)),a.isArray(d.images)&&a.each(d.images,function(a,b){e.imageCount++,b.id=d.generated_id+"-image"+e.imageCount,e.addImage(b)}),c.find(".gallery-image-holder").sortable({connectWith:".gallery-image-holder",forceHelperSize:!0,forcePlaceholderSize:!0,placeholder:"contentblocks-gallery-placeholder",tolerance:"pointer",cursor:"move",update:function(){b.fixColumnHeights(),b.fireChange()},start:function(a,b){b.placeholder.height(b.item.height())}}),b.toBoolean(d.properties.show_description)||c.addClass("no-description"),b.toBoolean(d.properties.show_link_field)||c.addClass("no-link-field")},e.chooseImage=function(){var a=d.properties.max_images,f=c.find(".gallery-image-holder").find("li").length;if(a>0&&f>=a)return b.alert(_("contentblocks.max_images_reached",{max:a})),!1;var g=MODx.load({xtype:"modx-browser",id:Ext.id(),multiple:!0,listeners:{select:function(a){e.chooseImageCallback(a)}},allowedFileTypes:d.properties.file_types,hideFiles:!0,title:_("contentblocks.choose_image"),source:e.source});g.setSource(e.source),g.show()},e.chooseImageCallback=function(a){var b=a.fullRelativeUrl;"http"!=b.substr(0,4)&&"/"!=b.substr(0,1)&&(b=MODx.config.base_url+b),e.imageCount++;var d=c.attr("id")+"-image"+e.imageCount,f=a.size,g=a.ext;this.addImage({url:b,title:a.filename,description:"",link:"",id:d,size:f,extension:g})},e.addImage=function(e){var f=c.find(".gallery-image-holder");e.description=e.description||"",e.link=e.link||"",f.append(tmpl("contentblocks-field-gallery-item",e));var g=a("#"+e.id);g.find(".contentblocks-gallery-image-delete").on("click",function(){g.fadeOut(function(){g.remove(),b.fixColumnHeights(),b.fireChange()})}),b.toBoolean(d.properties.show_link_field)&&b.initializeLinkField(g.find(".linkfield"))},e.initUpload=function(){var f=c.attr("id"),g=d.properties.max_images;c.find("#"+f+"-upload").fileupload({url:ContentBlocksConfig.connectorUrl+"?action=content/image/upload",dataType:"json",dropZone:a("#"+f),progressInterval:250,paramName:"file",multiple:!0,pasteZone:null,add:function(d,h){var i=c.find(".gallery-image-holder").find("li").length;if(g>0&&i>=g)return b.alert(_("contentblocks.max_images_reached",{max:g})),!1;e.imageCount++;var j=f+"-image"+e.imageCount;h.files[0].ext=h.files[0].name.split(".").pop(),e.addImage({title:h.files[0].name,url:"",id:j,size:h.files[0].size,extension:h.files[0].ext}),h.domId="#"+j;var k=a(h.domId);if(k.addClass("uploading"),h.files[0].size<7e5&&window.FileReader){var l=new FileReader;l.onload=function(a){k.find("img").attr("src",a.target.result),b.fixColumnHeights()},l.readAsDataURL(h.files[0])}setTimeout(function(){h.submit()},1e3),b.fireChange()},done:function(c,d){var e=a(d.domId);if(d.result.success){var f=d.result.object;e.find(".url").val(f.url),e.find("img").attr("src",f.url),e.find(".size").val(f.size),e.find(".extension").val(f.extension),e.removeClass("uploading")}else{var g=_("contentblocks.upload_error",{file:d.files[0].filename,message:d.result.message});d.files[0].size>1572864&&(g+=_("contentblocks.upload_error.file_too_big")),b.alert(g),e.remove()}setTimeout(function(){b.fixColumnHeights()},150)},fail:function(c,d){var e=_("contentblocks.upload_error",{file:d.files[0].filename,message:d.result.message});d.files[0].size>1572864&&(e+=_("contentblocks.upload_error.file_too_big")),b.alert(e),a(d.domId).remove(),b.fixColumnHeights()},formData:function(){return[{name:"HTTP_MODAUTH",value:MODx.siteId},{name:"resource",value:MODx.request.id||0},{name:"field",value:d.id}]},progress:function(b,c){var d=parseInt(c.loaded/c.total*100,10)+"%";a(c.domId).find(".upload-progress .bar").width(d)}}).on("fileuploaddragover",function(){a(this).css("background","red")})},e.getData=function(){var d=[];return c.find(".gallery-image-holder li").each(function(c,e){var f=a(e),g=f.find("input[id].linkfield"),h={url:f.find(".url").val(),title:f.find(".title").val(),description:f.find(".description").val(),link:g.val(),linkType:b.getLinkFieldDataType(g.val()),size:f.find(".size").val(),extension:f.find(".extension").val()};d.push(h)}),{images:d}},e}}(vcJquery,ContentBlocks);
//# sourceMappingURL=gallery-min.js.map